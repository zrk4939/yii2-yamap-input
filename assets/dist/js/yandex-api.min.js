var searchInput=$("#address-search");function YandexApiConstructor(a){this.map=null;this.mapBlockId=a.mapBlockId||"yandex-map";this.fields=a.fields;this.click_handle=a.click_handle;this.leadLatLng=a.leadLatLng;this.blocks={latitude:null,longitude:null,cityName:null,address:null,CountryName:null,AdministrativeAreaName:null,SubAdministrativeAreaName:null,LocalityName:null,street:null,home:null};var c=this;var b=$(".search-address-cancel");this.init=function(){if(!window.ymaps){return false}this.initMap();this.initBlocks();this.drawDistricts();this.actionUpdate();this.initEvents()};this.initMap=function(){c.map=new ymaps.Map(c.mapBlockId,{center:[58.6,49.62],zoom:15,controls:["typeSelector","zoomControl"]},{autoFitToViewport:false},{balloonMaxWidth:200})};this.initBlocks=function(){$.each(c.fields,function(d,e){if(e!==""){c.blocks[d]=$(document.getElementById(e))}})};this.drawDistricts=function(){var d=$('[name="districts"]').val();try{d=JSON.parse(d)}catch(f){d=[]}$.each(d,function(e,h){var i=JSON.parse(h.polygon);var g=new ymaps.Polygon(i,{hintContent:h.name},{fillColor:"#aaaaaa",strokeColor:"#555555",strokeWidth:2,opacity:0.3,interactivityModel:"default#transparent"});c.map.geoObjects.add(g)})};this.newPlaceMark=function(f,e){var d=new ymaps.Placemark(f,{},{draggable:true});c.map.geoObjects.add(d);d.events.add("dragend",function(){f=d.geometry.getCoordinates();if(c.fields.latitude&&c.fields.longitude){c.blocks.latitude.val(f[0]);c.blocks.longitude.val(f[1])}c.getAddressOfCoordinates(f)});if(e){c.map.setCenter(f)}};this.actionUpdate=function(){if(c.blocks.latitude&&c.blocks.longitude&&c.blocks.latitude.val()&&c.blocks.longitude.val()){var e=c.blocks.latitude.val();var d=c.blocks.longitude.val();this.newPlaceMark([e,d],true);if(c.leadLatLng){c.getAddressOfCoordinates([e,d])}}else{if(c.blocks.address){this.searchByAddress(c.blocks.address.val())}}};this.initEvents=function(){if(c.click_handle==="true"){this.initClickEvent()}this.initCancelButton();this.initSearchForm()};this.initClickEvent=function(){c.map.events.add("click",function(d){var f=d.get("coords");c.getAddressOfCoordinates(f);c.clearMap();c.newPlaceMark(f,false);if(c.blocks.latitude&&c.blocks.longitude){c.blocks.latitude.val(f[0]);c.blocks.longitude.val(f[1])}})};this.initSearchForm=function(){$(document).on("keyup","#address-search",function(g){g.preventDefault();$("#search-address-variants li").remove();var d="https://geocode-maps.yandex.ru/1.x/?apikey=583bbe5d-c554-4031-bbea-ce44ffaf8194",h=$(this).val(),f=g.keyCode||g.which;if(h.length>3&&f!==13){$.ajax({url:d+"&format=json&geocode="+h,success:function(e){c.viewObjects(e.response.GeoObjectCollection.featureMember)}})}return false});$(document).on("change","#address-search",function(d){d.preventDefault();if($(this).val().length){b.show()}else{b.hide()}return false});searchInput.parents("form:first").on("keyup keypress",function(f){var d=f.keyCode||f.which;if(d===13&&f.target.name==="search-address"){f.preventDefault();c.searchByAddress($("#address-search").val());return false}});$(document).on("click",".search-address-variants-one, .search-address-variants-one a",function(){var d=$(this).text();c.searchByAddress(d);$("#search-address-variants li").remove()})};this.initCancelButton=function(){b.on("click",function(){$("#search-address-variants li").remove();$("#address-search").val("").change()})};this.viewObjects=function(d){d.forEach(function(e){var f=e.GeoObject,g=f.metaDataProperty.GeocoderMetaData.text;$("<li />").addClass("search-address-variants-one").append($("<a />").text(g)).appendTo($("#search-address-variants"))})};this.getAddressOfCoordinates=function(d){this.getDataKindOfCoordinates(d,"",function(f){var i=f.geoObjects.get(0),j=i.properties.get("metaDataProperty"),e="";console.log(j);if(c.blocks.CountryName){e=j.GeocoderMetaData.AddressDetails.Country.CountryName;c.blocks.CountryName.val(e)}if(c.blocks.AdministrativeAreaName){e=j.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.AdministrativeAreaName;c.blocks.AdministrativeAreaName.val(e)}if(c.blocks.SubAdministrativeAreaName){e="";try{e=j.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.Locality.DependentLocality.DependentLocalityName}catch(g){e=j.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.SubAdministrativeAreaName}c.blocks.SubAdministrativeAreaName.val(e)}if(c.blocks.LocalityName){e=j.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.Locality.LocalityName;c.blocks.LocalityName.val(e)}if(c.blocks.street){e=i.getThoroughfare();c.blocks.street.val(e)}if(c.blocks.home){var h=i.getPremiseNumber();c.blocks.home.val(h)}if(c.blocks.cityName){e=i.properties.get("description");c.blocks.cityName.val(e)}if(c.blocks.address){e=j.GeocoderMetaData.text;c.blocks.address.val(e)}$("#address-search").val(j.GeocoderMetaData.text).change()})};this.getDataKindOfCoordinates=function(g,e,d,f){ymaps.geocode(g,{results:1,kind:e}).then(d,f)};this.searchByAddress=function(d){ymaps.geocode(d,{results:1}).then(function(e){var f=e.geoObjects.get(0).geometry.getCoordinates();c.clearMap();c.newPlaceMark(f,true);if(c.blocks.latitude&&c.blocks.latitude.length){c.blocks.latitude.val(f[0])}if(c.blocks.longitude&&c.blocks.longitude.length){c.blocks.longitude.val(f[1])}c.getAddressOfCoordinates(f)},function(e){})};this.clearMap=function(){this.map.geoObjects.removeAll();c.drawDistricts()}};